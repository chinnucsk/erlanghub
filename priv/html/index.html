<!DOCTYPE html>
<html>
<head>
    <title>Erlanghub Events</title>
    <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico">
    <style>
        html, body {margin:0; padding:0;}
        body {font:50% Helvetica, Arial, sans-serif; }
        #stage {margin: 0 auto; margin-top: 1em; text-align:left; font-size:2.1em; width:99%; -moz-border-radius: 15px;
        border-radius: 15px; border:2px solid #000; }
        #header {text-align:center; }
        /* Messages Display Area */
        #Events {margin:0 auto; margin-bottom: 20px; border:1px solid #CCC; width:90%; height:15em; overflow:auto;
        background-color: #F8F8F8; }
        #msgList {margin:0px; padding:5px; list-style:none;}
        #msgList li {padding:5px 10px; border-bottom:1px solid gray;}
        .error {color:red;}
    </style>
    <script type="text/javascript"  src="http://ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js"></script>
    <script type="text/javascript">window.jQuery || document.write(unescape("%3Cscript src='/static/jquery.js' type='text/javascript'%3E%3C/script%3E"));</script>


    <script>

        $(function () {

        var timestamp = 0;
        var pullUrl = "/pull";

        // bind events for the messages area

        var EventsDisplay = {
        print:function (messages) {
        $.each(messages, function (index, value) {

        // work with value
        msg = value.replace("\\", "");
        obj = JSON.parse(msg);
        $.getJSON(obj.repo.url, function (data) {
        $("#msgList").prepend('<li>' + obj.type + " : " +  data.name + " @ <a href='" + data.html_url + "'>" + obj.repo.name + "</a> Language: " + data.language + '</li>');
        });

        });
        },
        error:function (error) {
        $("#msgList").prepend('<li><span class="error">' + error + '</span></li>');
        }
        };

        $('#Events').bind({
        'pull':function () {
        $.ajax({
        url:pullUrl + "/?since=" + timestamp,
        dataType:"json",
        method:"GET",
        success:function (data) {
        if (data.timestamp) {
        timestamp = data.timestamp;
        if (data.timeout == "true") {
        // means that a timeout was trigered on the server
        $('#Events').triggerHandler("pull")
        } else {
        EventsDisplay.print(data.messages);
        $('#Events').triggerHandler("pull")
        }
        }
        else {
        EventsDisplay.error("Failed to pull due to this data: " + data);
        // $('#Events').triggerHandler("pull");
        }
        },
        error:function (jqXHR, textStatus, errorThrown) {
        chatDisplay.error("Failed to pull due to this status: " + textStatus + " and error: " + errorThrown);
        // $('#Events').triggerHandler("pull");
        }
        });
        setTimeout(function () { /* Do Nothing here */
        }, 1);
        }
        }).triggerHandler("pull"); // kick off the pull event after all the events are bound to the Events object


        });

    </script>
</head>
<body>
<div id="stage">
    <div id="header">
        <h1>Erlanghub</h1>
    </div>
    <!-- chat messages will be rendered inside this div, prepended to msgList -->
    <div id="Events">
        <ul id="msgList"></ul>
    </div>

</div>
</body>
</html>

